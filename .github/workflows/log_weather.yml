name: India AWS Logger

on:
  schedule:
    - cron: '5,35 * * * *'  # Every 30 minutes (at 5 and 35 minutes past each hour)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  log-india-weather:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install Python packages
        run: |
          pip install --upgrade pip
          pip install pandas numpy requests tabulate beautifulsoup4 thermofeel pytz
      
      - name: Pull latest data
        run: git pull origin main
      
      - name: Run weather logger script
        run: python scripts/IMDdata.py

      - name: Generate trend data
        run: python scripts/generate_trends.py
      
      - name: Commit & push updated logs
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Stage changes first
          git add weather_logs/*.csv weather_logs/*.json

          # Commit if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "[Auto] Update India weather logs $(date -u +'%Y-%m-%d %H:%M UTC')"

          # Try to push with retry logic
          max_attempts=3
          attempt=1
          while [ $attempt -le $max_attempts ]; do
            if git push origin main; then
              echo "Push succeeded"
              exit 0
            fi

            echo "Push failed, attempt $attempt/$max_attempts. Pulling and retrying..."

            # Abort any failed rebase
            git rebase --abort 2>/dev/null || true

            # Use merge instead of rebase to avoid conflicts with data files
            git pull --no-rebase origin main -X theirs || true

            # Re-stage and amend if needed
            git add weather_logs/*.csv weather_logs/*.json
            git diff --staged --quiet || git commit --amend --no-edit

            attempt=$((attempt + 1))
            sleep 3
          done

          echo "Failed to push after $max_attempts attempts"
          exit 1